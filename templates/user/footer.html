<footer class="bg-light py-3">
    <div class="container text-center">
        <h5>DMA</h5>
        <p>E-Commerce Data Management Application</p>
        <div class="d-flex justify-content-center mb-2">
            <a href="https://github.com/tkdesign" target="_blank" class="btn btn-link text-decoration-none"><i
                    class="bi bi-github"></i></a>
        </div>
        <div>
            <span>&copy; 2025 — <strong>Kovalenko Petr</strong></span>
        </div>
    </div>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
{% if page == 'dashboard' %}
<script src="{{ url_for('static', filename='assets/plotly/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/plotly/plotly-locale-sk.js') }}"></script>
<script>
    function loadChart(endpoint, containerId) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Container with ID "${containerId}" not found.`);
            return;
        }

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                //data.layout.title = '';
                data.layout.width = 400;
                data.layout.height = 300;
                Plotly.newPlot(containerId, data.data, data.layout)
                    .catch(error => console.error(`Error plotting "${containerId}":`, error));
            })
            .catch(error => console.error(`Error fetching data for "${containerId}":`, error));
    }

    function render_dashboard(filter) {
        if (!filter) {
            params = '';
        } else {
            params = '?';
            for (const key in filter) {
                params += `${key}=${filter[key]}&`;
            }
        }

        fetch('/get-summary' + params)
            .then(response => response.json())
            .then(data => {
                document.getElementById('carts-count').innerHTML =
                    parseInt(data.carts_count).toLocaleString('sk-SK') + `<br><div class="card-numeric-subtitle">Košíky</div>`;
                document.getElementById('orders-count').innerHTML =
                    parseInt(data.orders_count).toLocaleString('sk-SK') + `<br><div class="card-numeric-subtitle">Objednávky</div>`;
                document.getElementById('total-revenue').innerHTML =
                    Math.round(data.total_revenue).toLocaleString('sk-SK') + ` &euro;` +
                    `<br><div class="card-numeric-subtitle">Príjmy</div>`;
                document.getElementById('conversion-rate').innerHTML =
                    Math.round(data.conversion_rate).toLocaleString('sk-SK') + '%' +
                    `<br><div class="card-numeric-subtitle">Konverzia</div>`;
            })
            .catch(error => console.error('Error loading summary:', error));

        loadChart('/get-monthly-revenue' + params, 'monthly-revenue-chart');
        loadChart('/get-orders-heatmap' + params, 'orders-heatmap-chart');
        loadChart('/get-gender-distribution' + params, 'gender-distribution-chart');
        loadChart('/get-age-distribution' + params, 'age-distribution-chart');
        loadChart('/get-gender-quartile-distribution' + params, 'gender-quartile-distribution-chart');
        loadChart('/get-order-status-heatmap' + params, 'order-status-heatmap');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const chartContainers = [
            'monthly-revenue-chart',
            'gender-distribution-chart',
            'order-status-heatmap',
            'age-distribution-chart'
        ];
        chartContainers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.style.minHeight = '300px';
            }
        });

        render_dashboard(null);

        const applyMonthFilterBtn = document.getElementById('apply-month-filter');
        if (applyMonthFilterBtn) {
            applyMonthFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const monthFilter = document.getElementById('month-filter');
                if (!monthFilter) {
                    return
                }
                render_dashboard({filter_type: "month", filter_value: monthFilter.value});
            });
        }

        const applyQuarterFilterBtn = document.getElementById('apply-quarter-filter');
        if (applyQuarterFilterBtn) {
            applyQuarterFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const quarterFilter = document.getElementById('quarter-filter');
                if (!quarterFilter) {
                    return
                }
                render_dashboard({filter_type: "quarter", filter_value: quarterFilter.value});
            });
        }

        const applyYearFilterBtn = document.getElementById('apply-year-filter');
        if (applyYearFilterBtn) {
            applyYearFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const yearFilter = document.getElementById('year-filter');
                if (!yearFilter) {
                    return
                }
                render_dashboard({filter_type: "year", filter_value: yearFilter.value});
            });
        }

        const applyGenderFilterBtn = document.getElementById('apply-date-range-filter');
        if (applyGenderFilterBtn) {
            applyGenderFilterBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const startDateFilter = document.getElementById('start-date-filter');
                const endDateFilter = document.getElementById('end-date-filter');
                if (!startDateFilter || !endDateFilter) {
                    return
                }
                render_dashboard({filter_type: "range", filter_value_start: startDateFilter.value, filter_value_end: endDateFilter.value});
            });
        }
    });
</script>
{% elif page == 'etl_control' %}
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = new Tabulator("#etl-table", {
            layout:"fitColumns",
            pagination:true,
            {#paginationMode:"remote",#}
            paginationSize:10,
            paginationInitialPage:1,
            ajaxURL: "{{ url_for('admin.etl_data') }}",
            ajaxConfig:"GET",
            placeholder:"No ETL log data available",
            columns: [
                {title:"ID", field:"id", sorter:"number", width:60},
                {title:"Job Name", field:"job_name", sorter:"string"},
                {title:"Started At", field:"started_at", sorter:"date", formatter:"datetime", formatterParams: {
                    inputFormat: 'iso',
                    outputFormat:"yyyy-MM-dd HH:mm:ss",
                    invalidPlaceholder:"-"
                }},
                {title:"Ended At", field:"ended_at", sorter:"date", formatter:"datetime", formatterParams: {
                    inputFormat: 'iso',
                    outputFormat:"yyyy-MM-dd HH:mm:ss",
                    invalidPlaceholder:"-"
                }},
                {title:"Status", field:"status", sorter:"string", formatter:function(cell) {
                    var status = cell.getValue();
                    if(status === "RUNNING") {
                        return "<span class='badge bg-primary'>" + status + "</span>";
                    } else if(status === "SUCCESS") {
                        return "<span class='badge bg-success'>" + status + "</span>";
                    } else if(status === "FAILED") {
                        return "<span class='badge bg-danger'>" + status + "</span>";
                    } else if(status === "REVOKED") {
                        return "<span class='badge bg-secondary'>" + status + "</span>";
                    }
                    return status;
                }},
                {title:"Message", field:"message", sorter:"string"},
                {title:"Tables Processed", field:"tables_processed", sorter:"number"},
                {title:"Actions", field:"actions", formatter:function(cell){
                    const data = cell.getRow().getData();
                    if(data.status === "RUNNING" && data.task_id) {
                        return "<button class='btn btn-sm btn-danger stop-task-btn' data-task-id='" + data.task_id + "'>Stop</button>";
                    }
                    return "";
                }, width:100}
            ],
            rowFormatter:function(row) {
                const data = row.getData();
                if(data.status === "RUNNING") {
                    row.getElement().style.backgroundColor = "#fff3cd";
                }
            }
        });

        setInterval(function(){
            table.setData();
        }, 10000);

        document.getElementById("start-etl-btn").addEventListener("click", function() {
            fetch("{{ url_for('admin.run_etl_chain') }}", {
                method:"GET",
                headers: {"Content-Type": "application/json"}
            })
            .then(response => response.json())
            .then(data => {
                const error = data.hasOwnProperty("error");
                if (error) {
                    alert("Error starting ETL: " + data.error);
                    return;
                }
                const taskId = (data.hasOwnProperty("chain_task_id") ? data.chain_task_id : null);
                alert("ETL process started. Task ID: " + taskId);
                table.setData();
            })
            .catch(error => {
                console.error("Error starting ETL:", error);
            });
        });

        document.getElementById("etl-table").addEventListener("click", function(e) {
            if(e.target && e.target.matches("button.stop-task-btn")) {
                const taskId = e.target.getAttribute("data-task-id");
                fetch("{{ url_for('admin.revoke_task') }}", {
                    method:"POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({task_id: taskId})
                })
                .then(response => response.json())
                .then(data => {
                    alert("Task " + taskId + " revoked.");
                    table.setData();
                })
                .catch(error => {
                    console.error("Error revoking task:", error);
                });
            }
        });

        const updateStatus = (elementId, data) => {
            let msg = 'Unknown', className = 'bg-secondary';

            if (data) {
                const error = data.hasOwnProperty('error');
                const status = data.hasOwnProperty('status');

                if (error) {
                    className = 'bg-danger';
                    msg = 'Failed';
                } else if (status) {
                    msg = data.status;
                    switch (msg.toLocaleLowerCase()) {
                        case 'running':
                            className = 'bg-primary';
                            break;
                        case 'ok':
                        case 'idle':
                            className = 'bg-success';
                            break;
                        case 'unavailable':
                            className = 'bg-warning';
                            break;
                        case 'failed':
                            className = 'bg-danger';
                            break;
                        default:
                            className = 'bg-secondary';
                            break;
                    }
                }
            }

            const element = document.getElementById(elementId);
            if (element) {
                element.className = 'badge';
                element.classList.add(className);
                element.textContent = element.textContent.split(':')[0] + ': ' + msg;
            }
        };

        const checkStatuses = () => {
            fetch('{{ url_for('admin.prod_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('prod-db-status', data))
                .catch(() => updateStatus('prod-db-status', null));

            fetch('{{ url_for('admin.stage_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('stage-db-status', data))
                .catch(() => updateStatus('stage-db-status', null));

            fetch('{{ url_for('admin.dwh_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('dwh-status', data))
                .catch(() => updateStatus('dwh-status', null));

            fetch('{{ url_for('admin.redis_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('redis-db-status', data))
                .catch(() => updateStatus('redis-db-status', null));

            fetch('{{ url_for('admin.celery_worker_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('celery-worker-status', data))
                .catch(() => updateStatus('celery-worker-status', null));
        };

        checkStatuses();
        setInterval(checkStatuses, 5000);
    });
</script>
{% elif page == 'profile' %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileForm = document.getElementById('edit-profile-form');
        const profileCard = document.getElementById('profile-card');
        if (editProfileBtn && editProfileForm && profileCard) {
            {% if error %}
            editProfileForm.classList.toggle('d-none');
            profileCard.classList.toggle('d-none');
            {% endif %}
            editProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editProfileForm.classList.toggle('d-none');
                profileCard.classList.toggle('d-none');
            });
        }
    });
</script>
{% endif %}
</body>
</html>