{% extends "user/layout.html" %}
{% block content %}
<div class="container my-4">
    <h1 class="mb-4">ETL Process Control</h1>
    <div class="mb-3">
        <button id="start-etl-btn" class="btn btn-primary">Start ETL Process</button>
    </div>
    <div id="etl-table"></div>
</div>
<link href="{{ url_for('static', filename='assets/tabulator/css/tabulator_bootstrap5.min.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
var table = new Tabulator("#etl-table", {
    layout:"fitColumns",
    pagination:true,
    paginationMode:"remote",
    paginationSize:10,
    paginationInitialPage:1,
    ajaxURL: "{{ url_for('admin.etl_data') }}",
    ajaxConfig:"GET",
    placeholder:"No ETL log data available",
    columns:[
        {title:"ID", field:"id", sorter:"number", width:60},
        {title:"Job Name", field:"job_name", sorter:"string"},
        {title:"Started At", field:"started_at", sorter:"date", formatter:"datetime", formatterParams:{
            inputFormat: 'iso',
            outputFormat:"yyyy-MM-dd HH:mm:ss",
            invalidPlaceholder:"-"
        }},
        {title:"Ended At", field:"ended_at", sorter:"date", formatter:"datetime", formatterParams:{
            inputFormat: 'iso',
            outputFormat:"yyyy-MM-dd HH:mm:ss",
            invalidPlaceholder:"-"
        }},
        {title:"Status", field:"status", sorter:"string", formatter:function(cell){
            var status = cell.getValue();
            if(status === "RUNNING"){
                return "<span class='badge bg-primary'>" + status + "</span>";
            } else if(status === "SUCCESS"){
                return "<span class='badge bg-success'>" + status + "</span>";
            } else if(status === "FAILED"){
                return "<span class='badge bg-danger'>" + status + "</span>";
            } else if(status === "REVOKED"){
                return "<span class='badge bg-secondary'>" + status + "</span>";
            }
            return status;
        }},
        {title:"Message", field:"message", sorter:"string"},
        {title:"Tables Processed", field:"tables_processed", sorter:"number"},
        {title:"Actions", field:"actions", formatter:function(cell){
            var data = cell.getRow().getData();
            if(data.status === "RUNNING" && data.task_id){
                return "<button class='btn btn-sm btn-danger stop-task-btn' data-task-id='" + data.task_id + "'>Stop</button>";
            }
            return "";
        }, width:100}
    ],
    rowFormatter:function(row){
        var data = row.getData();
        if(data.status === "RUNNING"){
            row.getElement().style.backgroundColor = "#fff3cd";
        }
    }
});

setInterval(function(){
    table.setData();
}, 10000);

document.getElementById("start-etl-btn").addEventListener("click", function(){
    fetch("{{ url_for('admin.run_etl_chain') }}", {
        method:"GET",
        headers: {"Content-Type": "application/json"}
    })
    .then(response => response.json())
    .then(data => {
        var taskId = (data.hasOwnProperty("chain_task_id") ? data.chain_task_id : null);
        alert("ETL process started. Task ID: " + taskId);
        table.setData();
    })
    .catch(error => {
        console.error("Error starting ETL:", error);
    });
});

document.getElementById("etl-table").addEventListener("click", function(e){
    if(e.target && e.target.matches("button.stop-task-btn")){
        var taskId = e.target.getAttribute("data-task-id");
        fetch("{{ url_for('admin.revoke_task') }}", {
            method:"POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({task_id: taskId})
        })
        .then(response => response.json())
        .then(data => {
            alert("Task " + taskId + " revoked.");
            table.setData();
        })
        .catch(error => {
            console.error("Error revoking task:", error);
        });
    }
});
</script>
{% endblock %}
