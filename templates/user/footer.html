<footer class="bg-light py-3">
    <div class="container text-center">
        <h5>DMA</h5>
        <p>Aplikácia pre správu ecommerce dát </p>
        <div class="d-flex justify-content-center mb-2">
            <a href="https://github.com/tkdesign/dma" target="_blank" class="btn btn-link text-decoration-none"><i
                    class="bi bi-github"></i></a>
        </div>
        <div>
            <span>&copy; 2025 — <strong>Kovalenko Petr</strong></span>
        </div>
    </div>
</footer>
<script src="{{ url_for('static', filename='assets/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
{% if page == 'dashboard' %}
<script src="{{ url_for('static', filename='assets/plotly/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/plotly/plotly-locale-sk.js') }}"></script>
<script>
    const svg_download_icon = {
        width: 1000,
        height: 1000,
        path: "M875 281.25V875a125 125 0 0 1-125 125v-62.5a62.5 62.5 0 0 0 62.5-62.5V281.25h-125A93.75 93.75 0 0 1 593.75 187.5V62.5H250a62.5 62.5 0 0 0-62.5 62.5v562.5H125V125a125 125 0 0 1 125-125h343.75zM0 927.5625a70.625 70.625 0 0 0 25.0625 51.4375q12.125 10.125 29.875 15.75q17.8125 5.6875 41.5625 5.6875 31.6875 0 53.625-9.875 22.1875-9.875 33.75-27.5a73.125 73.125 0 0 0 11.6875-41.0q0-21.0-8.4375-35.0a62.5 62.5 0 0 0-23.4375-22.3125 125 125 0 0 0-35.3125-13.125l-38.8125-9.0a62.5 62.5 0 0 1-25.3125-11.0.23125.23125 0 0 1-8.9375-18.6875q0-14.625 11.5-24.0 11.6875-9.5 32.0625-9.5 13.375 0 23.125 4.25a37.5 37.5 0 0 1 15.3125 11.3125.35.35 0 0 1 7.5 16.125h46.875a68.75 68.75 0 0 0-12.4375-35.375 75 75 0 0 0-31.25-25.625 112.5 112.5 0 0 0-48.75-9.5q-27.5 0-48.5 9.375-21.0625 9.3125-33.0 26.3125-11.875 17.0625-11.875 39.9375 0 18.875 7.6875 32.75t21.9375 22.9375q14.3125 8.9375 33.75 13.3125l38.625 9.0q19.375 4.5625 28.875 12.0625a24.375 24.375 0 0 1 9.5625 20.375.3125.3125 0 0 1-5.3125 18.125.35.35 0 0 1-16.0 12.0625q-10.4375 4.375-25.8125 4.375-11.0 0-20.0-2.5a50 50 0 0 1-15.5-7.1875.3625.3625 0 0 1-15.9375-24.0zm285.9375 68.125h59.5l82.9375-249.9375h-54.9375l-55.4375 196.125H315.625l-56.0625-196.125h-57.3125zm342.6875-205.8125q7.125 14.25 8.75 30.75h-48.5a50 50 0 0 0-6.0-15.5625.4375.4375 0 0 0-10.625-11.875.4375.4375 0 0 0-14.8125-7.875 62.5 62.5 0 0 0-18.75-2.75q-26.6875 0-41.5 18.875-14.6875 18.75-14.6875 53.125v31.0625q0 22.0 6.0625 38.5a56.25 56.25 0 0 0 19.0625 25.8125.54375.54375 0 0 0 32.375 9.125 62.5 62.5 0 0 0 28.5625-6.0625.41875.41875 0 0 0 17.0625-16.4375q5.625-10.25 5.625-22.75v-15.875h-51.4375v-36.875h98.5v49.875q0 18.125-6.0 34.375a81.25 81.25 0 0 1-18.3125 28.5625 87.5 87.5 0 0 1-30.9375 19.625q-18.5 6.9375-43.625 6.9375a125 125 0 0 1-47.0-8.25 90.625 90.625 0 0 1-33.375-23.5625 100 100 0 0 1-19.9375-36.25 156.25 156.25 0 0 1-6.5625-46.5625v-31.6875q0-33.75 12.4375-59.3125 12.625-25.375 36.4375-39.5625 23.9375-14.25 57.875-14.25q22.3125 0 39.6875 6.25 17.625 6.25 30.0 17.1875 12.5 11.0 19.625 25.4375",
        transform: "matrix(1 0 0 -1 0 1000)"
    };
    const config = {
        locale: 'sk',
        responsive: true,
        toImageButtonOptions: {
            format: 'png',
            filename: 'chart_png',
            height: 500,
            width: 700,
            scale: 1,
        },
        modeBarButtonsToAdd: [
            {
                name: 'Uložiť ako SVG',
                icon: svg_download_icon,
                click: function(gd) {
                    Plotly.downloadImage(gd, {
                        format: 'svg',
                        filename: 'chart_svg',
                        height: 500,
                        width: 700,
                        scale: 1
                    });
                }
            }
        ],
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d'],
        displaylogo: false,
    };
    function loadChart(endpoint, containerId) {
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Kontajner s ID "${containerId}" nenájdený.`);
            return;
        }

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                if (!data.hasOwnProperty('layout')) {
                    return;
                }
                Plotly.newPlot(containerId, data.data, data.layout, config)
                .catch(error => console.error(`Chyba pri vykresľovaní "${containerId}":`, error));
            })
            .catch(error => console.error(`Chyba pri načítavaní údajov pre "${containerId}":`, error));
    }

    function render_dashboard(filter) {
        if (!filter) {
            params = '';
        } else {
            params = '?';
            for (const key in filter) {
                params += `${key}=${filter[key]}&`;
            }
        }

        fetch('{{ url_for('dashboard.get_summary') }}' + params)
            .then(response => response.json())
            .then(data => {
                document.getElementById('carts-count').innerHTML =
                    parseInt(data.carts_count).toLocaleString('sk-SK') + `<br><div class="card-numeric-subtitle">Košíky</div>`;
                document.getElementById('orders-count').innerHTML =
                    parseInt(data.orders_count).toLocaleString('sk-SK') + ' / ' + parseInt(data.orders_paid_count).toLocaleString('sk-SK') +`<br><div class="card-numeric-subtitle">Objednávky</div>`;
                document.getElementById('conversion-rate').innerHTML =
                    Math.round(data.conversion_rate).toLocaleString('sk-SK') + ' / ' + Math.round(data.conversion_rate_paid).toLocaleString('sk-SK') + ' %' +
                    `<br><div class="card-numeric-subtitle">Konverzia</div>`;
                document.getElementById('total-revenue').innerHTML =
                    Math.round(data.total_revenue).toLocaleString('sk-SK') + ` &euro;` +
                    `<br><div class="card-numeric-subtitle">Príjmy</div>`;

            })
            .catch(error => console.error('Chybné načítanie prehľadu:', error));

        loadChart('{{ url_for('dashboard.get_period_revenue') }}' + params, 'period-revenue-chart');
        loadChart('{{ url_for('dashboard.get_orders_heatmap') }}' + params, 'orders-heatmap-chart');
        loadChart('{{ url_for('dashboard.get_carrier_revenue_orders_distribution') }}' + params, 'carrier-revenue-orders-distribution-chart');
        loadChart('{{ url_for('dashboard.get_top_manufacturer_revenue_distribution') }}' + params, 'top-manufacturer-revenue-distribution-chart');
        loadChart('{{ url_for('dashboard.get_market_group_revenue_distribution') }}' + params, 'market-group-revenue-distribution-chart');
        loadChart('{{ url_for('dashboard.get_gender_distribution') }}' + params, 'gender-distribution-chart');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const chartContainers = [
            'period-revenue-chart',
            'order-status-heatmap',
            'carrier-revenue-orders-distribution-chart',
            'top-manufacturer-revenue-distribution-chart',
            'market-group-revenue-distribution-chart',
            'gender-distribution-chart',
        ];
        chartContainers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.style.minHeight = '300px';
            }
        });

        render_dashboard(null);

        const applyMonthFilterBtn = document.getElementById('apply-month-filter');
        if (applyMonthFilterBtn) {
            applyMonthFilterBtn.addEventListener('click', (e) => {
                const monthFilter = document.getElementById('month-filter');
                if (!monthFilter) {
                    return
                }
                render_dashboard({filter_type: "month", filter_value: monthFilter.value});
            });
        }

        const applyQuarterFilterBtn = document.getElementById('apply-quarter-filter');
        if (applyQuarterFilterBtn) {
            applyQuarterFilterBtn.addEventListener('click', (e) => {
                const quarterFilter = document.getElementById('quarter-filter');
                if (!quarterFilter) {
                    return
                }
                render_dashboard({filter_type: "quarter", filter_value: quarterFilter.value});
            });
        }

        const applyYearFilterBtn = document.getElementById('apply-year-filter');
        if (applyYearFilterBtn) {
            applyYearFilterBtn.addEventListener('click', (e) => {
                const yearFilter = document.getElementById('year-filter');
                if (!yearFilter) {
                    return
                }
                render_dashboard({filter_type: "year", filter_value: yearFilter.value});
            });
        }

        const applyGenderFilterBtn = document.getElementById('apply-date-range-filter');
        if (applyGenderFilterBtn) {
            applyGenderFilterBtn.addEventListener('click', (e) => {
                const startDateFilter = document.getElementById('start-date-filter');
                const endDateFilter = document.getElementById('end-date-filter');
                if (!startDateFilter || !endDateFilter) {
                    return
                }
                render_dashboard({filter_type: "range", filter_value_start: startDateFilter.value, filter_value_end: endDateFilter.value});
            });
        }
    });
</script>
{% elif page == 'etl_control' %}
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = new Tabulator("#etl-table", {
            layout: "fitColumns",
            pagination: true,
            paginationMode: "remote",
            filterMode: "remote",
            sortMode: "remote",
            dataLoader: false,
            paginationSize: 10,
            paginationInitialPage: 1,
            ajaxURL: "{{ url_for('admin.etl_data') }}",
            ajaxConfig: "GET",
            placeholder: "Žiadne záznamy o migrácii údajov nie sú dostupné",
            langs:{
                "default":{
                    "pagination": {
                        "first": "Prvá",
                        "first_title": "Prvá strana",
                        "last": "Posledná",
                        "last_title": "Posledná strana",
                        "prev": "Predchádzajúca",
                        "prev_title": "Predchádzajúca strana",
                        "next": "Ďalšia",
                        "next_title": "Ďalšia strana",
                        "all": "Všetky"
                    }
                },
            },
            columns: [
                {title: "ID", field: "id", sorter: "number", width: 60, headerFilter:"input", headerFilterFunc:"="},
                {title: "Názov úlohy", field: "job_name", sorter: "string", headerFilter:"input"},
                {title: "Spustené o", field: "started_at", sorter: "date", formatter: "datetime", formatterParams: {
                        inputFormat: 'iso',
                        outputFormat: "yyyy-MM-dd HH:mm:ss",
                        invalidPlaceholder: "-"
                    }
                },
                {title: "Ukončené o", field: "ended_at", sorter: "date", formatter: "datetime", formatterParams: {
                        inputFormat: 'iso',
                        outputFormat: "yyyy-MM-dd HH:mm:ss",
                        invalidPlaceholder: "-"
                    }
                },
                {title: "Stav", field: "status", sorter: "string", formatter: function (cell) {
                        const status = cell.getValue();
                        if (status === "RUNNING") {
                            return "<span class='badge bg-primary'>PREBIEHA</span>";
                        } else if (status === "SUCCESS") {
                            return "<span class='badge bg-success'>ÚSPECH</span>";
                        } else if (status === "FAILED") {
                            return "<span class='badge bg-danger'>ZLYHANIE</span>";
                        } else if (status === "REVOKED") {
                            return "<span class='badge bg-secondary'>ZRUŠENÉ</span>";
                        }
                        return status;
                    }
                },
                {title: "Hlásenie", field: "message", sorter: "string", headerFilter:"input"},
                {title: "Spracované tabuľky", field: "tables_processed", sorter: "number"},
                {title: "Akcie", field: "actions", headerSort: false, formatter: function (cell){
                    const data = cell.getRow().getData();
                    if(data.status === "RUNNING" && data.task_id) {
                        return "<button class='btn btn-sm btn-danger stop-task-btn' data-task-id='" + data.task_id + "'>Zastaviť</button>";
                    }
                    return "";
                }, width: 100}
            ],
            rowFormatter:function(row) {
                const data = row.getData();
                if(data.status === "RUNNING") {
                    row.getElement().style.backgroundColor = "#fff3cd";
                }
            }
        });

        setInterval(function() {
            const autorefreshETLTable = document.getElementById('autorefresh_etl_table');
            if (autorefreshETLTable && !autorefreshETLTable.checked) {
                return;
            }
            table.setData();
        }, 10000);

        const startETLBtn = document.getElementById('start-etl-btn');
        if (startETLBtn) {
            startETLBtn.addEventListener("click", function() {
                if (!confirm("Naozaj chcete spustiť migráciu údajov?")) {
                    return;
                }
                const stageReloadAction = document.getElementById('stage_reload_action');
                const dwhIncrementalAction = document.getElementById('dwh_incremental_action');

                const stage_reload_action = !!(stageReloadAction && stageReloadAction.checked);
                const dwh_incremental_action = !!(dwhIncrementalAction && dwhIncrementalAction.checked);

                const url_params = new URLSearchParams({
                    stage_reload: stage_reload_action,
                    dwh_incremental: dwh_incremental_action
                }).toString();

                fetch("{{ url_for('admin.run_etl_chain') }}?" + url_params, {
                    method:"GET",
                    data: {stage_reload_action: stage_reload_action, dwh_incremental_task: dwh_incremental_action},
                    headers: {"Content-Type": "application/json"}
                })
                .then(response => response.json())
                .then(data => {
                    const error = data.hasOwnProperty("error");
                    if (error) {
                        alert("Chyba počas migrácie údajov: " + data.error);
                        return;
                    }
                    const taskId = (data.hasOwnProperty("task_id") ? data.task_id : null);
                    alert("Začala sa migrácia údajov. ID úlohy: " + taskId);
                    table.setData();
                })
                .catch(error => {
                    console.error("Chyba počas migrácie údajov:", error);
                });
            });
        }

        const etlTableElement = document.getElementById('etl-table');
        if (etlTableElement) {
            etlTableElement.addEventListener('click', function (e) {
                if (e.target && e.target.matches('button.stop-task-btn')) {
                    const taskId = e.target.getAttribute("data-task-id");
                    fetch("{{ url_for('admin.revoke_task') }}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({task_id: taskId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert("Úloha " + taskId + " zrušená.");
                        table.setData();
                    })
                    .catch(error => {
                        console.error("Chyba pri rušení úlohy:", error);
                    });
                }
            });
        }

        const updateStatus = (elementId, data) => {
            let className = 'bg-secondary';

            if (data) {
                const error = data.hasOwnProperty('error');
                const status = data.hasOwnProperty('status');

                if (error) {
                    className = 'bg-danger';
                } else if (status) {
                    switch (data.status.toLocaleLowerCase()) {
                        case 'running':
                            className = 'bg-primary';
                            break;
                        case 'ok':
                        case 'idle':
                            className = 'bg-success';
                            break;
                        case 'unavailable':
                            className = 'bg-warning';
                            break;
                        case 'failed':
                            className = 'bg-danger';
                            break;
                        default:
                            className = 'bg-secondary';
                            break;
                    }
                }
            }

            const element = document.getElementById(elementId);
            if (element) {
                element.className = 'badge';
                element.classList.add(className);
            }
        };

        const checkStatuses = () => {
            fetch('{{ url_for('admin.prod_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('prod-db-status', data))
                .catch(() => updateStatus('prod-db-status', null));

            fetch('{{ url_for('admin.stage_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('stage-db-status', data))
                .catch(() => updateStatus('stage-db-status', null));

            fetch('{{ url_for('admin.dwh_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('dwh-status', data))
                .catch(() => updateStatus('dwh-status', null));

            fetch('{{ url_for('admin.redis_db_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('redis-db-status', data))
                .catch(() => updateStatus('redis-db-status', null));

            fetch('{{ url_for('admin.celery_worker_status') }}')
                .then(response => response.json())
                .then(data => updateStatus('celery-worker-status', data))
                .catch(() => updateStatus('celery-worker-status', null));
        };

        checkStatuses();
        setInterval(checkStatuses, 5000);
    });
</script>
{% elif page == 'users' %}
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = new Tabulator("#users-table", {
            layout:"fitColumns",
            pagination: true,
            paginationMode: "remote",
            filterMode: "remote",
            sortMode: "remote",
            dataLoader: false,
            paginationSize: 10,
            paginationInitialPage: 1,
            ajaxURL: "{{ url_for('admin.users_data') }}",
            ajaxConfig:"GET",
            placeholder:"Žiadni používatelia nie sú k dispozícii",
            langs:{
                "default":{
                    "pagination": {
                        "first": "Prvá",
                        "first_title": "Prvá strana",
                        "last": "Posledná",
                        "last_title": "Posledná strana",
                        "prev": "Predchádzajúca",
                        "prev_title": "Predchádzajúca strana",
                        "next": "Ďalšia",
                        "next_title": "Ďalšia strana",
                        "all": "Všetky"
                    }
                },
            },
            columns: [
                {title:"ID", field:"id", sorter:"number", width:60, headerFilter:"input", headerFilterFunc:"="},
                {title:"Email", field:"email", sorter:"string", headerFilter:"input"},
                {title:"Rola", field:"role", sorter:"string"},
                {title:"Meno", field:"first_name", sorter:"string", headerFilter:"input"},
                {title:"Priezvisko", field:"last_name", sorter:"string", headerFilter:"input"},
                {title:"Oddelenie", field:"department", sorter:"string", headerFilter:"input"},
                {title:"Pozícia", field:"occupation", sorter:"string", headerFilter:"input"},
                {title:"Akcie", field:"actions", headerSort: false, formatter: function(cell) {
                    const data = cell.getRow().getData();
                    const user_edit_url = "{{ url_for('admin.user_edit', user_id=0) }}".replace('0', data.id);
                    return "<a href='" + user_edit_url + "' class='btn btn-sm btn-primary'>Upraviť</a>";
                }, width:100}
            ]
        });
    });
</script>
{% elif page == 'reports' %}
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const table = new Tabulator("#reports-table", {
            layout: "fitColumns",
            pagination: true,
            paginationMode: "remote",
            filterMode: "remote",
            sortMode: "remote",
            dataLoader: false,
            paginationSize: 10,
            paginationInitialPage: 1,
            ajaxURL: "{{ url_for('reports.reports_data') }}",
            ajaxConfig: "GET",
            placeholder: "Nie sú k dispozícii žiadne správy",
            langs:{
                "default":{
                    "pagination": {
                        "first": "Prvá",
                        "first_title": "Prvá strana",
                        "last": "Posledná",
                        "last_title": "Posledná strana",
                        "prev": "Predchádzajúca",
                        "prev_title": "Predchádzajúca strana",
                        "next": "Ďalšia",
                        "next_title": "Ďalšia strana",
                        "all": "Všetky"
                    }
                },
            },
            columns: [
                {title: "ID", field: "id", sorter: "number", width: 60, headerFilter:"input", headerFilterFunc:"="},
                {title: "Typ správy", field: "report_type", sorter: "string", headerFilter:"input"},
                {title: "Spustené o", field: "started_at", sorter: "date", formatter: "datetime", formatterParams: {
                        inputFormat: 'iso',
                        outputFormat: "yyyy-MM-dd HH:mm:ss",
                        invalidPlaceholder: "-"
                    }
                },
                {title: "Ukončené o", field: "ended_at", sorter: "date", formatter: "datetime", formatterParams: {
                        inputFormat: 'iso',
                        outputFormat: "yyyy-MM-dd HH:mm:ss",
                        invalidPlaceholder: "-"
                    }
                },
                {title: "Status", field: "status", sorter: "string", formatter: function (cell) {
                        const status = cell.getValue();
                        if (status === "RUNNING") {
                            return "<span class='badge bg-primary'>" + status + "</span>";
                        } else if (status === "SUCCESS") {
                            return "<span class='badge bg-success'>" + status + "</span>";
                        } else if (status === "FAILED") {
                            return "<span class='badge bg-danger'>" + status + "</span>";
                        } else if (status === "REVOKED") {
                            return "<span class='badge bg-secondary'>" + status + "</span>";
                        }
                        return status;
                    }
                },
                {title: "Hlásenie", field: "message", sorter: "string", headerFilter:"input"},
                {title: "Akcie", field: "actions", headerSort: false, formatter: function (cell) {
                    const data = cell.getRow().getData();
                    if(data.status === "RUNNING" && data.task_id) {
                        return "<button class='btn btn-sm btn-danger stop-task-btn' data-task-id='" + data.task_id + "'>Zastaviť</button>";
                    } else if (data.status === "SUCCESS") {
                        const view_report_url = "{{ url_for('reports.view_report', report_id=0) }}".replace('0', data.id);
                        return "<a href='" + view_report_url + "' class='btn btn-sm btn-primary'>Zobraziť</a>";
                    }
                    return "";
                }, width: 100}
            ]
        });

        setInterval(function(){
            const autorefreshReportsTable = document.getElementById('autorefresh_reports_table');
            if (autorefreshReportsTable && !autorefreshReportsTable.checked) {
                return;
            }
            table.setData();
        }, 10000);

        const createReportBtn = document.getElementById('create-report-btn');
        if (createReportBtn) {
            createReportBtn.addEventListener('click', (e) => {
                const reportTypeFilter = document.getElementById('report-type-filter');
                if (reportTypeFilter) {
                    const selectedOption = reportTypeFilter.options[reportTypeFilter.selectedIndex];
                    if (!selectedOption) {
                        alert("Vyberte typ správy");
                        return;
                    }

                    let date_filter_type = '';
                    let date_filter_value = '';
                    let start_date_filter = '';
                    let end_date_filter = '';
                    const date_filter = document.querySelector('input[name="date_filter"]:checked');
                    if (date_filter) {
                        date_filter_type = date_filter.value;

                        if (date_filter_type === 'date-range') {
                            date_filter_type = 'range';
                            start_date_filter = document.getElementById('start-date-filter').value;
                            end_date_filter = document.getElementById('end-date-filter').value;
                        } else if (date_filter_type === 'month') {
                            date_filter_value = document.getElementById('month-filter').value;
                        } else if (date_filter_type === 'quarter') {
                            date_filter_value = document.getElementById('quarter-filter').value;
                        } else if (date_filter_type === 'year') {
                            date_filter_value = document.getElementById('year-filter').value;
                        }
                    }

                    const subfilters = {};
                    const selectedSubfilters = selectedOption.getAttribute('data-subfilters');
                    if (selectedSubfilters && selectedSubfilters.length > 0) {
                        selectedSubfilters.split(',').forEach(subfilter => {
                            const filter = subfilter.trim();
                            const filterElement = document.getElementById(filter);
                            if (filterElement) {
                                subfilters[filter] = filterElement.value;
                            }
                        });
                    }

                    fetch("{{ url_for('reports.create_report') }}", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({report_type: selectedOption.value, date_filter_type: date_filter_type, date_filter_value: date_filter_value, start_date_filter: start_date_filter, end_date_filter: end_date_filter, subfilters: subfilters})
                    })
                    .then(response => response.json())
                    .then(data => {
                        const error = data.hasOwnProperty("error");
                        if (error) {
                            alert("Chyba pri vytváraní správy: " + data.error);
                            return;
                        }
                        const taskId = (data.hasOwnProperty("task_id") ? data.task_id : null);
                        alert("Začalo sa vytváranie správy. ID úlohy: " + taskId);
                        table.setData();
                    })
                    .catch(error => {
                        console.error("Chyba pri vytváraní správy:", error);
                    });
                }
            });
        }

        const reportTable = document.getElementById('reports-table');
        if (reportTable) {
            reportTable.addEventListener("click", function(e) {
                if (e.target && e.target.matches('button.stop-task-btn')) {
                    const taskId = e.target.getAttribute("data-task-id");
                    fetch("{{ url_for('admin.revoke_task') }}", {
                        method:"POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({task_id: taskId})
                    })
                    .then(response => response.json())
                    .then(data => {
                        alert("Úloha " + taskId + " zrušená.");
                        table.setData();
                    })
                    .catch(error => {
                        console.error("Chyba pri rušení úlohy:", error);
                    });
                }
            });
        }

        const reportTypeFilter = document.getElementById('report-type-filter');
        if (reportTypeFilter) {
            reportTypeFilter.addEventListener('change', (e) => {
                Array.from(e.target.options).forEach(option => {
                    const subfilters = option.getAttribute('data-subfilters');
                    if (subfilters) {
                        subfilters.split(',').forEach(subfilter => {
                            const filter = subfilter.trim();
                            const filterElement = document.getElementById(filter);
                            if (filterElement) {
                                filterElement.parentElement.parentElement.classList.add('d-none');
                            }
                        });
                    }
                });

                const selectedOption = e.target.options[e.target.selectedIndex];
                const selectedSubfilters = selectedOption.getAttribute('data-subfilters');
                if (selectedSubfilters && selectedSubfilters.length > 0) {
                    let date_filter_type = '';
                    let date_filter_value = '';
                    let start_date_filter = '';
                    let end_date_filter = '';
                    const date_filter = document.querySelector('input[name="date_filter"]:checked');
                    if (date_filter) {
                        date_filter_type = date_filter.value;
                        if (date_filter_type === 'date-range') {
                            date_filter_type = 'range';
                            start_date_filter = document.getElementById('start-date-filter').value;
                            end_date_filter = document.getElementById('end-date-filter').value;
                        } else if (date_filter_type === 'month') {
                            date_filter_value = document.getElementById('month-filter').value;
                        } else if (date_filter_type === 'quarter') {
                            date_filter_value = document.getElementById('quarter-filter').value;
                        } else if (date_filter_type === 'year') {
                            date_filter_value = document.getElementById('year-filter').value;
                        }
                    }

                    selectedSubfilters.split(',').forEach(subfilter => {
                        const filter = subfilter.trim();
                        const filterElement = document.getElementById(filter);
                        if (filterElement) {
                            fetch("{{ url_for('reports.get_subfilter_options') }}", {
                                method: "POST",
                                headers: {"Content-Type": "application/json"},
                                body: JSON.stringify({report_type: selectedOption.value, date_filter_type: date_filter_type, date_filter_value: date_filter_value, start_date_filter: start_date_filter, end_date_filter: end_date_filter, subfilter: filter})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (!data.hasOwnProperty('elements')) {
                                    return;
                                }
                                filterElement.innerHTML = '';
                                data.elements.forEach(option => {
                                    filterElement.innerHTML += `<option value="${option.key}">${option.value}</option>`;
                                });
                            })
                            .catch(error => {
                                console.error(`Chybné načítanie filtra "${filter}":`, error);
                            });

                            filterElement.parentElement.parentElement.classList.remove('d-none');
                        }
                    });
                }
            });
        }
    });
</script>
{% elif page == 'view_report' %}
<script src="{{ url_for('static', filename='assets/plotly/plotly.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/plotly/plotly-locale-sk.js') }}"></script>
<script src="{{ url_for('static', filename='assets/luxon/luxon.min.js') }}"></script>
<script src="{{ url_for('static', filename='assets/tabulator/js/tabulator.min.js') }}"></script>
<script>
    let report_id = "{{ report.id }}";
    let createdAt = "{{ report.ended_at.strftime('%Y-%m-%d %H:%M:%S') }}";
    let reportParametersData = {{ report_parameters|tojson }};
    let reportData = {{ report.result|tojson }};
    function displayDetails() {
        const reportDetails = document.getElementById('report-details');
        if (!reportDetails) {
            return;
        }
        const reportId = document.getElementById('report-id');
        const reportTitle = document.getElementById('report-title');
        const reportType = document.getElementById('report-type');
        const reportCreatedAt = document.getElementById('report-created-at');
        const reportDateFilter = document.getElementById('report-date-filter');

        if (reportId) {
            reportId.textContent = report_id;
        }
        if (reportTitle) {
            reportTitle.textContent = (reportParametersData.hasOwnProperty('report_title') ? reportParametersData.report_title : '');
        }
        if (reportType) {
            reportType.textContent = (reportParametersData.hasOwnProperty('report_type') ? reportParametersData.report_type : '');
        }
        if (reportCreatedAt) {
            reportCreatedAt.textContent = createdAt;
        }
        if (reportParametersData.hasOwnProperty('filters')) {
            if (reportDateFilter && reportParametersData.filters.hasOwnProperty('date_filter_type')) {
                if (reportParametersData.filters.date_filter_type === 'date-range') {
                    reportDateFilter.textContent = `${reportParametersData.filters.start_date_filter} - ${reportParametersData.filters.end_date_filter}`;
                } else if (reportParametersData.filters.date_filter_type === 'month') {
                    reportDateFilter.textContent = reportParametersData.filters.date_filter_value;
                } else if (reportParametersData.filters.date_filter_type === 'quarter') {
                    reportDateFilter.textContent = reportParametersData.filters.date_filter_value;
                } else if (reportParametersData.filters.date_filter_type === 'year') {
                    reportDateFilter.textContent = reportParametersData.filters.date_filter_value;
                }
            }
            if (reportParametersData.filters.hasOwnProperty('report_subfilters')) {
                for (let i = 0; i < reportParametersData.filters.report_subfilters.length; i++) {
                    const subfilter = reportParametersData.filters.report_subfilters[i];
                    const keys = Object.keys(subfilter);
                    for (let j = 0; j < keys.length; j++) {
                        const key = keys[j];
                        const value = subfilter[key];
                        const dt = document.createElement('dt');
                        if (value.title.length > 0 && value.value.length > 0) {
                            dt.className = 'col-sm-3';
                            dt.textContent = value.title || 'Bez názvu';
                            const dd = document.createElement('dd');
                            dd.className = 'col-sm-9';
                            dd.textContent = value.value || 'Bez hodnoty';
                            reportDetails.appendChild(dt);
                            reportDetails.appendChild(dd);
                        }
                    }
                }
            }
        }
    }
    {% if report_data_type == 'table' %}
    async function downloadCSV() {
        const response = await fetch('{{ url_for('reports.download_csv_report', report_id = report.id ) }}', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({report_id: report_id})
        });

        if (!response.ok) {
            console.error('Chyba pri načítavaní CSV súboru: ', await response.text());
            return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'report.csv';
        a.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
        displayDetails();
        const containerId = 'table-container';
        if (!document.getElementById(containerId)) {
            console.error(`Kontajner s ID "${containerId}" nenájdený.`);
            return;
        }
        columns = [
            {% for column in report.result.get("columns") %}
            {title: "{{ column }}", field: "{{ column }}"},
            {% endfor %}
        ];
        const table = new Tabulator(`#${containerId}`, {
            layout: "fitColumns",
            pagination: true,
            paginationMode: "remote",
            filterMode: "remote",
            sortMode: "remote",
            dataLoader: false,
            paginationSize: 10,
            paginationInitialPage: 1,
            ajaxURL: "{{ url_for('reports.get_csv_table', report_id=report.id) }}",
            ajaxConfig: "GET",
            placeholder: "Nie sú k dispozícii žiadne riadky",
            langs:{
                "default":{
                    "pagination": {
                        "first": "Prvá",
                        "first_title": "Prvá strana",
                        "last": "Posledná",
                        "last_title": "Posledná strana",
                        "prev": "Predchádzajúca",
                        "prev_title": "Predchádzajúca strana",
                        "next": "Ďalšia",
                        "next_title": "Ďalšia strana",
                        "all": "Všetky"
                    }
                },
            },
            columns: columns,
        });
        {#const downloadCSVBtn = document.getElementById('download-csv-btn');
        if (downloadCSVBtn) {
            downloadCSVBtn.addEventListener('click', downloadCSV);
        }#}
    });
    {% else %}
    const svg_download_icon = {
        width: 1000,
        height: 1000,
        path: "M875 281.25V875a125 125 0 0 1-125 125v-62.5a62.5 62.5 0 0 0 62.5-62.5V281.25h-125A93.75 93.75 0 0 1 593.75 187.5V62.5H250a62.5 62.5 0 0 0-62.5 62.5v562.5H125V125a125 125 0 0 1 125-125h343.75zM0 927.5625a70.625 70.625 0 0 0 25.0625 51.4375q12.125 10.125 29.875 15.75q17.8125 5.6875 41.5625 5.6875 31.6875 0 53.625-9.875 22.1875-9.875 33.75-27.5a73.125 73.125 0 0 0 11.6875-41.0q0-21.0-8.4375-35.0a62.5 62.5 0 0 0-23.4375-22.3125 125 125 0 0 0-35.3125-13.125l-38.8125-9.0a62.5 62.5 0 0 1-25.3125-11.0.23125.23125 0 0 1-8.9375-18.6875q0-14.625 11.5-24.0 11.6875-9.5 32.0625-9.5 13.375 0 23.125 4.25a37.5 37.5 0 0 1 15.3125 11.3125.35.35 0 0 1 7.5 16.125h46.875a68.75 68.75 0 0 0-12.4375-35.375 75 75 0 0 0-31.25-25.625 112.5 112.5 0 0 0-48.75-9.5q-27.5 0-48.5 9.375-21.0625 9.3125-33.0 26.3125-11.875 17.0625-11.875 39.9375 0 18.875 7.6875 32.75t21.9375 22.9375q14.3125 8.9375 33.75 13.3125l38.625 9.0q19.375 4.5625 28.875 12.0625a24.375 24.375 0 0 1 9.5625 20.375.3125.3125 0 0 1-5.3125 18.125.35.35 0 0 1-16.0 12.0625q-10.4375 4.375-25.8125 4.375-11.0 0-20.0-2.5a50 50 0 0 1-15.5-7.1875.3625.3625 0 0 1-15.9375-24.0zm285.9375 68.125h59.5l82.9375-249.9375h-54.9375l-55.4375 196.125H315.625l-56.0625-196.125h-57.3125zm342.6875-205.8125q7.125 14.25 8.75 30.75h-48.5a50 50 0 0 0-6.0-15.5625.4375.4375 0 0 0-10.625-11.875.4375.4375 0 0 0-14.8125-7.875 62.5 62.5 0 0 0-18.75-2.75q-26.6875 0-41.5 18.875-14.6875 18.75-14.6875 53.125v31.0625q0 22.0 6.0625 38.5a56.25 56.25 0 0 0 19.0625 25.8125.54375.54375 0 0 0 32.375 9.125 62.5 62.5 0 0 0 28.5625-6.0625.41875.41875 0 0 0 17.0625-16.4375q5.625-10.25 5.625-22.75v-15.875h-51.4375v-36.875h98.5v49.875q0 18.125-6.0 34.375a81.25 81.25 0 0 1-18.3125 28.5625 87.5 87.5 0 0 1-30.9375 19.625q-18.5 6.9375-43.625 6.9375a125 125 0 0 1-47.0-8.25 90.625 90.625 0 0 1-33.375-23.5625 100 100 0 0 1-19.9375-36.25 156.25 156.25 0 0 1-6.5625-46.5625v-31.6875q0-33.75 12.4375-59.3125 12.625-25.375 36.4375-39.5625 23.9375-14.25 57.875-14.25q22.3125 0 39.6875 6.25 17.625 6.25 30.0 17.1875 12.5 11.0 19.625 25.4375",
        transform: "matrix(1 0 0 -1 0 1000)"
    };
    const config = {
        locale: 'sk',
        responsive: true,
        toImageButtonOptions: {
            format: 'png',
            filename: 'chart_png',
            height: 500,
            width: 700,
            scale: 1,
        },
        modeBarButtonsToAdd: [
            {
                name: 'Uložiť ako SVG',
                icon: svg_download_icon,
                click: function(gd) {
                    Plotly.downloadImage(gd, {
                        format: 'svg',
                        filename: 'chart_svg',
                        height: 500,
                        width: 700,
                        scale: 1
                    });
                }
            }
        ],
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d'],
        displaylogo: false,
    };
    async function showReport() {
        displayDetails();

        if (!reportData.hasOwnProperty('layout')) {
            return;
        }
        const containerId = 'chart-container';
        const container = document.getElementById(containerId);
        if (!container) {
            console.error(`Kontajner s ID "${containerId}" nenájdený.`);
            return;
        }

        Plotly.newPlot(containerId, reportData.data, reportData.layout, config)
        .then(() => {
            Plotly.relayout(containerId, {autosize: true});
        })
        .catch(error => console.error(`Chyba pri vykresľovaní "${containerId}":`, error));
    }

    async function generatePDF() {
        const response = await fetch('{{ url_for('reports.generate_pdf') }}', {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({report_id: report_id})
        });

        if (!response.ok) {
            console.error('Chyba pri generovaní PDF súboru:', await response.text());
            return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'report.pdf';
        a.click();
    }

    document.addEventListener('DOMContentLoaded', () => {
        showReport();

        const generatePDFBtn = document.getElementById('generate-pdf-btn');
        if (generatePDFBtn) {
            generatePDFBtn.addEventListener('click', generatePDF);
        }
    });
    {% endif %}
</script>
{% elif page == 'profile' %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const editProfileContainer = document.getElementById('edit-profile-container');
        const viewProfileContainer = document.getElementById('view-profile-container');
        if (editProfileBtn && editProfileContainer && viewProfileContainer) {
            {% if error %}
            editProfileContainer.classList.toggle('d-none');
            viewProfileContainer.classList.toggle('d-none');
            {% endif %}
            editProfileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                editProfileContainer.classList.toggle('d-none');
                viewProfileContainer.classList.toggle('d-none');
            });
        }
    });
</script>
{% endif %}
</body>
</html>